define(["jquery","core/ajax","core/notification"],function(a,b,c){var d=function(b,c){var d=b.find("tr:has(td)"),e=String.fromCharCode(11),f=String.fromCharCode(0),g='","',h='"\r\n"',i='"'+d.map(function(b,c){var d=a(c),f=d.find("td.includeincsv");return f.map(function(b,c){var d=a(c),e=d.text();return e.replace(/"/g,'""')}).get().join(e)}).get().join(f).split(f).join(h).split(e).join(g)+'"';if(window.navigator.msSaveBlob){var j=new Blob([decodeURIComponent(i)],{type:"text/csv;charset=utf8"});window.navigator.msSaveBlob(j,c)}else if(window.Blob&&window.URL){var j=new Blob([i],{type:"text/csv;charset=utf-8"}),k=URL.createObjectURL(j);a(this).attr({download:c,href:k})}else{var l="data:application/csv;charset=utf-8,"+encodeURIComponent(i);a(this).attr({download:c,href:l,target:"_blank"})}};return{init:function(){a(".rbp_dropdown").change(function(){var d=a(this).find(".optionvalue:selected"),e=a("#rbp_userrow_"+this.id),f=a("#tabletoexport").data("restoreid"),g={id:a(this).val(),username:d.data("username"),firstname:d.data("firstname"),lastname:d.data("lastname"),useremail:d.data("useremail")},h={id:this.id,username:e.data("username"),firstname:e.data("firstname"),lastname:e.data("lastname"),useremail:e.data("useremail")};g.username?b.call([{methodname:"local_remote_backup_provider_update_user_entry_in_backup",args:{id:this.id,restoreid:f,username:g.username,firstname:g.firstname,lastname:g.lastname,useremail:g.useremail},done:function(){e.find("td").eq(4).html("merge with existing user")},fail:c.exception}]):b.call([{methodname:"local_remote_backup_provider_update_user_entry_in_backup",args:{id:this.id,restoreid:f,username:h.username,firstname:h.firstname,lastname:h.lastname,useremail:h.useremail},done:function(){e.find("td").eq(4).html("create as new user")},fail:c.exception}])}),a(".rbp_delete").click(function(){var d=a("#tabletoexport").data("restoreid"),e=this.id;b.call([{methodname:"local_remote_backup_provider_delete_user_entry_from_backup",args:{id:this.id,restoreid:d},done:function(){a("#rbp_userrow_"+e).remove()},fail:c.exception}])}),a("#linktodownload").click(function(){var b=[a("#tabletoexport>table"),"userlist.csv"];d.apply(this,b)}),a("#continue").click(function(){var d=a("#continue").data("href"),e=a("#tabletoexport").data("restoreid"),f=d+"&filename=updated_backup.mbz";b.call([{methodname:"local_remote_backup_provider_create_updated_backup",args:{restoreid:e},done:function(){window.location=f},fail:c.exception}])})}}});